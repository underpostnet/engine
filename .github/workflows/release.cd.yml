name: CD | Release deployment | remote ssh

on:
  workflow_run:
    workflows: ['CI | Publish npm package']
    types:
      - completed

jobs:
  after-publish:
    if: github.repository == 'underpostnet/pwa-microservices-template' || startsWith(github.event.head_commit.message, 'cd(ssh-release)')
    runs-on: ubuntu-latest
    steps:
      - name: Run remote deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          # Remote host (secret)
          host: ${{ secrets.SSH_HOST }}
          # Remote user (secret)
          username: ${{ secrets.SSH_USERNAME }}
          # Private key (secret) â€” the PEM contents (not a path)
          key: ${{ secrets.SSH_PRIV_KEY }}
          # Remote port (optional)
          port: ${{ secrets.SSH_PORT }}
          # Optional: if your private key has a passphrase, add:
          # passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          # Commands to run on the remote VM
          script: |
            set -e
            echo "Starting remote release deploy"
            cd /home/dd/engine
            npm install -g underpost
            underpost run secret
            underpost run pull
            underpost run secret
            node bin run git-conf
            node bin run template-deploy-image
            underpost config set GITHUB_USERNAME underpostnet
            underpost run ssh-deploy sync-engine-core-test
