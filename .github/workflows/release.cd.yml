name: CD | Release deployment | remote ssh

on:
  workflow_run:
    workflows: ['CI | Publish npm package']
    types:
      - completed

jobs:
  after-publish:
    if: github.repository == 'underpostnet/pwa-microservices-template' || startsWith(github.event.head_commit.message, 'cd(ssh-release)')
    runs-on: ubuntu-latest
    steps:
      - name: Run remote deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          # Remote host (secret)
          host: ${{ secrets.SSH_HOST }}
          # Remote user (secret)
          username: ${{ secrets.SSH_USERNAME }}
          # Private key (secret) â€” the PEM contents (not a path)
          key: ${{ secrets.SSH_PRIV_KEY }}
          # Remote port (optional)
          port: ${{ secrets.SSH_PORT }}
          # Optional: increase timeout for long-running commands
          command_timeout: 60m
          # Optional: if your private key has a passphrase, add:
          # passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          # Commands to run on the remote VM
          script: |
            set -e
            echo "Starting remote release deploy"
            cd /home/dd/engine
            sudo -n -- /bin/bash -lc "node bin run pull"
            sudo -n -- /bin/bash -lc "underpost run secret"
            sudo -n -- /bin/bash -lc "npm install -g underpost"
            sudo -n -- /bin/bash -lc "underpost run secret"
            sudo -n -- /bin/bash -lc "node bin run --dev git-conf"
            sudo -n -- /bin/bash -lc "node bin run --dev template-deploy-image"
            sudo -n -- /bin/bash -lc "node bin run --dev ssh-deploy sync-engine-test"
